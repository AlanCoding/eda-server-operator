---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    {{ lookup("template", "../common/templates/labels/common.yaml.j2")  | indent(width=4) | trim }}
    {{ lookup("template", "../common/templates/labels/version.yaml.j2") | indent(width=4) | trim }}
    app.kubernetes.io/component: '{{ deployment_type }}-api'
  name: '{{ ansible_operator_meta.name }}-api'
  namespace: '{{ ansible_operator_meta.namespace }}'
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: '{{ ansible_operator_meta.name }}'
      app.kubernetes.io/managed-by: '{{ deployment_type }}-operator'
      app.kubernetes.io/component: '{{ deployment_type }}-api'
  template:
    metadata:
      labels:
        {{ lookup("template", "../common/templates/labels/common.yaml.j2")  | indent(width=8) | trim }}
        {{ lookup("template", "../common/templates/labels/version.yaml.j2") | indent(width=8) | trim }}
        app.kubernetes.io/component: '{{ deployment_type }}-api'
    spec:
      containers:
      - image: {{ _api_image }}
        name: eda-api
        args:
        - /bin/bash
        - -c
        - aap-eda-manage migrate && aap-eda-manage runserver 0.0.0.0:8000
        env:
        - name: EDA_DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: '{{ __postgres_configuration_secret }}'
              key: host
        - name: EDA_DB_HOST
          valueFrom:
            secretKeyRef:
              name: '{{ __postgres_configuration_secret }}'
              key: host
        - name: EDA_DATABASE_USERNAME
          valueFrom:
            secretKeyRef:
              name: '{{ __postgres_configuration_secret }}'
              key: username
        - name: EDA_DATABASE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: '{{ __postgres_configuration_secret }}'
              key: password
        - name: EDA_MQ_HOST
          value: {{ ansible_operator_meta.name }}-redis-svc
        ports:
        - containerPort: 8000
        resources: {{ api.resource_requirements }}
      restartPolicy: Always
